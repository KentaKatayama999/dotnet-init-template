# 初期プロジェクト作成・最小手順（草案）

> 目的：.NET ライブラリの新規プロジェクトを最短で立ち上げ、CI/整形/ブランチ方針まで“動く土台”を用意する。ここに質問→回答を追記していき、最終的に手順書に仕上げる。

---

## 0. 前提（決めごと）

- ブランチ名は **main** を採用（既存 master は合流時にリネームでOK）
- SDK 同梱 `` を使用（メジャー番号は SDK に準拠：**.NET 8 なら v8／.NET 9 なら v9**。NuGet ツール版は使わない）
- **TFM（例: net8.0）と SDK バージョンは独立**。SDK 9 でも net8.0 のビルドは可能。必要に応じて `global.json` で SDK を固定
- レイアウト：`src/`（本体）と `tests/`（テスト）を初期構成とし、`docs/` は必要に応じて追加（テンプレート初期状態には含めない）

---

## 1. ディレクトリとソリューション

- ルートフォルダを作成 → そこを **作業ルート**にする
- ソリューション（.sln）を作成
- ライブラリ（classlib）とテスト（xUnit）を作成し、.sln に追加

> ※ コマンド列は後で最小版を差し込む（必要になったら追記）

---

## 2. Git 初期化とブランチ

- リポジトリを初期化：`git init`
- 既定ブランチを **main** に設定（`git branch -M main`）
- 最初のコミット（空コミットでも可）

---

## 3. フォーマット & 改行方針

- SDK 版 `dotnet format` を使用（**インストール不要**）
- `.editorconfig`：UTF-8 / LF / 末尾改行 / インデント幅
- `.gitattributes`：基本 LF、Windows 固有は CRLF（\*.sln, \*.bat, \*.cmd）

---

## 4. CI（GitHub Actions）

- `.github/workflows/ci.yml` を追加
  - `actions/setup-dotnet@v4` で **PC に入っている SDK のメジャー版（例: 9.0.x）** を指定（必要に応じて `global.json` で固定）
  - 手順：`restore` → `format --verify-no-changes` → `build -c Release` → `test`
- 将来的にパッケージ発行が必要なら **pack/push** ジョブを別 yml で用意

---

## 5. 最小チェック

- `dotnet restore` → 成功
- `dotnet format --verify-no-changes` → 成功（差分なし）
- `dotnet build -c Release` → 成功
- `dotnet test -c Release` → 成功

---

## 6. リモート連携

- GitHub リポジトリを作成
- `git remote add origin <URL>`
- `git push -u origin main`
- （任意）ブランチ保護ルール：PR 必須、必須チェックに CI を追加

---

## 7. 命名とパッケージ方針（ライブラリ想定）

- ルート：`PropellerDataset`
- IO 実装は分離：`PropellerDataset.FileIO.Json`
- テスト：`PropellerDataset.Tests`
- パック対象はライブラリのみ（Test は `IsPackable=false`）

---

## 8. Q&A 用メモ欄（ここに追記していく）

- **Q:** 先に Codex を起動してもいい？ → **A:** ルートへ移動してから起動が基本。差分は必ず承認制で適用
- **Q:** `ls` って何？ → **A:** PowerShell の `Get-ChildItem` のエイリアス（一覧表示）
- **Q:** フォーマッタは入れる？ → **A:** 入れない。SDK 同梱の `dotnet format` を使う

---

## 9. ルートに置く設定ファイル（チェックリスト）

- **README.md**：概要／使い方／ステータスバッジ
- **LICENSE**：ライセンス明記
- **.gitignore**：bin/obj/.vs/環境依存ファイルの除外
- **.editorconfig**：文字コード・改行・インデント・C# スタイル
- **.gitattributes**：改行（LF/CRLF）やマージ戦略の統一
- **global.json（任意）**：使う .NET SDK の固定（例：8.0.x / 9.0.x）
- **Directory.Build.props / Directory.Build.targets（任意）**：共通プロパティ（CIビルド、ソースリンク など）
- **nuget.config（任意）**：社内/私設フィードの追加、ソースの優先順位
- **stylecop.json（任意）**：StyleCop を使う場合の規約
- **SECURITY.md（任意）**：脆弱性報告の窓口
- **CONTRIBUTING.md（任意）**：貢献ガイド（PR ルール、コーディング規約）
- **CODEOWNERS（任意・.github/）**：レビュー自動アサイン
- **Issue/PR テンプレート（任意・.github/）**：課題・PR の記入フォーマット
- **.github/workflows/**：CI/CD の yml（format→build→test、必要なら pack/push）

---

## 10. 初期設定セット（テンプレ貼り付け）

> そのままコピペ→ファイル作成で使える最小テンプレ。必要に応じて調整してください。

### 10.1 `.gitignore`

```
# Build artifacts
bin/
obj/
out/
TestResults/
**/*.trx

# IDE / tooling
.vs/
.idea/
*.user
*.rsuser
*.suo
*.userosscache
*.sln.docstates

# Packages / NuGet
packages/
.nupkg/
*.nupkg
*.snupkg
nupkgs/

# OS junk
.DS_Store
Thumbs.db

# Logs / coverage / temp
*.log
*.coverage*
coverage/
.temp/
```

### 10.2 `.editorconfig`

```
root = true

[*]
charset = utf-8
end_of_line = lf
insert_final_newline = true
indent_style = space
indent_size = 4

[*.{json,yml,yaml}]
indent_size = 2

[*.cs]
dotnet_diagnostic.IDE0055.severity = warning
```

### 10.3 `.gitattributes`

```
# Normalize line endings
* text=auto eol=lf

# Keep Windows-specific files as CRLF
*.sln text eol=crlf
*.bat  text eol=crlf
*.cmd  text eol=crlf
```

### 10.4 `.github/workflows/ci.yml`

```
name: CI

on:
  pull_request:
  push:
    branches: [ main, master ]

permissions:
  contents: read

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x' # ← PC の SDK に合わせて 8.0.x / 9.0.x などに変更

      - name: Restore
        run: dotnet restore <SolutionName>.sln

      - name: Verify formatting
        run: dotnet format <SolutionName>.sln --verify-no-changes --no-restore

      - name: Build (Release)
        run: dotnet build <SolutionName>.sln --no-restore -c Release -p:ContinuousIntegrationBuild=true

      - name: Test (Release)
        run: dotnet test <SolutionName>.sln --no-build -c Release
```

---

## まとめ：テンプレート作成〜適用 & .NET インストール手順（最小）

> 新規マシンでも再現できるように、要点だけを一直線に。必要に応じて SDK のメジャーは 8 or 9 に読み替え。

### 0) .NET SDK のインストール
- **Windows**（winget）: `winget install Microsoft.DotNet.SDK.9`  
- **macOS**（Homebrew）: `brew install --cask dotnet-sdk`  
- **確認**: `dotnet --version`（9.x または 8.x が出ればOK）

> チームで挙動を揃える場合は、後で `global.json` で固定可能。

---

### 1) テンプレートの作成（ローカル）
1. 任意の場所にテンプレート用フォルダを作成: `prop-init-template/`
2. 配下にファイルを配置：
   - `.gitignore` / `.editorconfig` / `.gitattributes`
   - `.github/workflows/ci.yml`（`__SolutionName__` と `__SdkMajor__` を使用）
   - `src/tempInit/tempInit.csproj`、`tests/tempInit.Tests/tempInit.Tests.csproj` など **tempInit 名で統一**
3. **`.template.config/template.json`** を作成（最小）：
```json
{
  "$schema": "http://json.schemastore.org/template",
  "author": "YourName",
  "identity": "Normal.Init.Template",
  "name": "Normal initial settings",
  "shortName": "normal-init",
  "classifications": ["Starter", "CI", "EditorConfig"],
  "sourceName": "tempInit",
  "preferNameDirectory": false,
  "symbols": {
    "SolutionName": {"type": "parameter", "datatype": "text", "replaces": "__SolutionName__", "defaultValue": "MySolution"},
    "SdkMajor":     {"type": "parameter", "datatype": "text", "replaces": "__SdkMajor__",     "defaultValue": "9"}
  }
}
```

---

### 2) テンプレートをインストール
```bash
dotnet new --uninstall "<旧テンプレパス>"   # 初回は不要
dotnet new --install   "<prop-init-template のパス>"
dotnet new --list | findstr normal-init   # 一覧に出るか確認（mac/Linux は grep）
```

---

### 3) テンプレートを適用（プロジェクト生成）
```bash
mkdir MyProj && cd MyProj
# カレント直下に展開（preferNameDirectory: false なのでサブフォルダは作られない）
dotnet new normal-init -n PropellerDataset \
  --SolutionName PropellerDataset \
  --SdkMajor 9
```
- 生成物：`.gitignore` / `.editorconfig` / `.gitattributes` / `.github/workflows/ci.yml` / `src/PropellerDataset/...` / `tests/PropellerDataset.Tests/...`

---

### 4) ソリューションを作成・登録
```bash
dotnet new sln -n PropellerDataset
dotnet sln PropellerDataset.sln add \
  src/PropellerDataset/PropellerDataset.csproj \
  tests/PropellerDataset.Tests/PropellerDataset.Tests.csproj
```

---

### 5) 最小動作確認
```bash
dotnet restore PropellerDataset.sln
dotnet format PropellerDataset.sln --verify-no-changes
dotnet build  PropellerDataset.sln -c Release
dotnet test   PropellerDataset.sln -c Release --no-build
```

> CI は `ci.yml` の `dotnet-version: '__SdkMajor__.0.x'` → 展開時に 9.0.x（または 8.0.x）へ差し替わります。

---

### 6) トラブルシュート（超要点）
- 置換されない → `sourceName: "tempInit"` に対して **テンプレ内の名前が tempInit で統一**されているか／`symbols.*.replaces` が**完全一致**か
- サブフォルダができる → `--output .` を使う or `preferNameDirectory: false`（本テンプレは既に false）
- `.csproj` が読めない → ルート要素 `<Project>` がある最小 XML に戻す

---

### 7) 追加でやると便利
- `global.json` で SDK 固定（ローカル＝CI を一致）
- README / LICENSE の雛形追加
- NuGet 発行用の pack/push ワークフロー（別 yml）

---

## 11. postActions で .sln 自動生成（安定版・最終形）
> `{{name}}` のトークン展開に依存せず、失敗しにくい構成。

### 方針
- `template.json` の `preferNameDirectory` を **true** にする（`dotnet new -n <name>` で `<name>/` サブフォルダを作成）
- postActions は **カレントをその `<name>/` にしたうえで** 実行されるため、`dotnet new sln` を **名前指定なし**で作成→自動的に `<name>.sln` になる
- 次の postAction で、`src/<name>/<name>.csproj` と `tests/<name>.Tests/<name>.Tests.csproj` を .sln に追加

### `template.json` 変更差分（要点のみ）
```json
{
  "preferNameDirectory": true,
  "postActions": [
    {
      "id": "create-sln",
      "actionId": "3A7C4B45-1F5D-4A30-959A-51B88E82B5D2",
      "args": { "executable": "dotnet", "args": "new sln" }
    },
    {
      "id": "add-projects",
      "actionId": "D396686C-DE0E-4DE6-906D-291CD29FC5DE",
      "args": { "inRoot": true }
    }
  ]
}
```
※ テンプレ側のパスは **`sourceName: "tempInit"`** を前提に `src/tempInit/tempInit.csproj` と `tests/tempInit.Tests/tempInit.Tests.csproj` を用意。展開時に `-n <name>` で `tempInit → <name>` に置換される。

### 使い方（最短）
```bash
# テンプレ更新後は毎回再インストール
# dotnet new --uninstall <path>; dotnet new --install <path>

# 新規プロジェクト作成（サブフォルダ <name>/ に展開）
dotnet new normal-init -n PropellerDataset --SolutionName PropellerDataset --SdkMajor 9
# → <name>.sln 作成 → 2つの csproj を自動追加

# 動作確認
dotnet restore
dotnet build -c Release
otnet test  -c Release --no-build
```

### メモ
- 直下展開したい場合は `-o .` を使うか、`preferNameDirectory: false` に戻す（ただし postActions はトークン展開の影響を受けやすくなる）
- `--dry-run` では postActions は実行されないので生成確認は通常実行で

---

## 12. README テンプレ（最小）
> ルートに `README.md` を追加。プロジェクト名はテンプレ展開時の `-n <name>` をそのまま記入。

```md
# PropellerDataset

プロペラ形状データを扱う .NET ライブラリ。
- **入出力**: JSON によるシリアライズ / デシリアライズ
- **用途**: プロペラのピッチなど各種メタデータの参照、他ツールとのデータ連携

## 動作環境
- .NET SDK: 8 もしくは 9
- OS: Windows / macOS / Linux

## クイックスタート
```bash
# 取得後（またはテンプレ生成後）
dotnet restore
# コード整形（差分なし確認）
dotnet format --verify-no-changes
# ビルド & テスト
dotnet build -c Release
dotnet test  -c Release --no-build
```

## パッケージ
NuGet 発行を行う場合は、`PropellerDataset.csproj` に Package メタデータを設定してください。

## ライセンス
MIT
```

---

## 13. `Directory.Build.props` テンプレ
> ルートに `Directory.Build.props` を追加し、**全プロジェクト共通**のビルド方針を一元管理します。

```xml
<Project>
  <PropertyGroup>
    <!-- 共通ビルドオプション -->
    <LangVersion>latestMajor</LangVersion>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
    <Deterministic>true</Deterministic>

    <!-- アナライザー/スタイル -->
    <EnableNETAnalyzers>true</EnableNETAnalyzers>
    <AnalysisLevel>latest</AnalysisLevel>
    <EnforceCodeStyleInBuild>true</EnforceCodeStyleInBuild>

    <!-- CI 環境では警告をエラー化（GitHub Actions など） -->
    <TreatWarningsAsErrors Condition="'$(GITHUB_ACTIONS)' == 'true'">true</TreatWarningsAsErrors>

    <!-- パッケージ共通メタ（必要に応じて上書き） -->
    <RepositoryUrl>https://github.com/your/repo</RepositoryUrl>
    <PublishRepositoryUrl>true</PublishRepositoryUrl>
    <EmbedUntrackedSources>true</EmbedUntrackedSources>
    <IncludeSymbols>true</IncludeSymbols>
    <SymbolPackageFormat>snupkg</SymbolPackageFormat>
    <!-- README を NuGet に含める場合は、ルートの README.md を参照 -->
    <PackageReadmeFile>README.md</PackageReadmeFile>
  </PropertyGroup>

  <!-- テスト プロジェクトの慣習（名前で判定・任意） -->
  <PropertyGroup Condition="$(MSBuildProjectName.EndsWith('.Tests'))">
    <IsPackable>false</IsPackable>
  </PropertyGroup>
</Project>
```

> メモ
> - **CI での警告エラー化**は `GITHUB_ACTIONS` 環境変数で判定。別のCIでも同様の変数に切り替え可。
> - NuGet へ公開するライブラリのみ、個別 `.csproj` で `<IsPackable>true</IsPackable>` を指定してください。
> - SourceLink を使う場合は、公開リポであること・PDB 生成（既定でOK）が前提です。
---

## 14. 初期セットアップ自動化スクリプト（任意）

> ローカル操作の抜け漏れを防ぐため、`dotnet` コマンドの定型をスクリプト化しておくと便利。テンプレート出力に含めない場合は `.template.config` 配下で管理するか、`template.json` の `sources` で除外設定を追加する。

### PowerShell 例（`scripts/init.ps1`）

```powershell
param(
    [switch]$NoTest
)

Set-StrictMode -Version Latest
$ErrorActionPreference = 'Stop'

dotnet restore
dotnet format --verify-no-changes
dotnet build -c Release
if (-not $NoTest) {
    dotnet test -c Release --no-build --logger "trx;LogFileName=TestResults.trx"
}
```

### Bash 例（`scripts/init.sh`）

```bash
#!/usr/bin/env bash
set -euo pipefail

dotnet restore
dotnet format --verify-no-changes
dotnet build -c Release
dotnet test -c Release --no-build --logger "trx;LogFileName=TestResults.trx"
```

---

## 15. SDK / 依存バージョン管理方針

- `global.json` を用意すると、チーム全体で SDK メジャー/マイナーを固定できる。テンプレートでは任意ファイルとしているため、必要に応じて以下を追加。

```json
{
  "sdk": {
    "version": "9.0.100"
  }
}
```

- SDK 更新確認：`dotnet --list-sdks` でローカルに複数バージョンが入っていないかをチェック。
- Dependabot または Renovate で NuGet / GitHub Actions の定期更新に対応する。

```yaml
# .github/dependabot.yml
version: 2
updates:
  - package-ecosystem: "nuget"
    directory: "/"
    schedule:
      interval: "weekly"
  - package-ecosystem: "github-actions"
    directory: "/"
    schedule:
      interval: "weekly"
```

- サードパーティーフィード使用時は `nuget.config` にクレデンシャル管理ポリシーを追記しておく。

---

## 16. CI 拡張のヒント

- `actions/cache` で `~/.nuget/packages` をキャッシュすると、CI の `restore` を高速化できる。
- `dotnet test --logger "trx"` と `actions/upload-artifact` を組み合わせ、失敗時にもテスト結果をダウンロード可能にする。
- OS や .NET SDK のマトリクスを広げる場合は、`DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=1` など必要な環境変数を設定。

```yaml
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Test
        run: dotnet test -c Release --no-build --logger "trx;LogFileName=TestResults.trx"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: TestResults/**/*.trx
```

---

## 17. 品質チェック強化（ローカル / CI）

- 警告をローカルでも検出したい場合は `dotnet build -c Release -warnaserror` を推奨。`Directory.Build.props` の `TreatWarningsAsErrors` に Condition を追加してローカルでも有効化できる。
- 追加アナライザー例：`dotnet add package StyleCop.Analyzers`、`dotnet add package Roslynator.Analyzers`。必要に応じて `AnalysisLevel` を `latestAll` へ設定。
- 静的解析ツール（例：`dotnet tool install --local dotnet-format`、`dotnet tool install --local dotnet-reportgenerator-globaltool`）を `dotnet tool restore` → `dotnet tool run <name>` の流れで CI に組み込む。
- カバレッジ計測：`dotnet test --collect:"XPlat Code Coverage"` → ReportGenerator で HTML 化。

---

## 18. パッケージ公開準備（任意）

- `Directory.Build.props` もしくは公開対象 `.csproj` にメタデータを追加。

```xml
<PropertyGroup>
  <PackageId>PropellerDataset</PackageId>
  <Version>1.0.0</Version>
  <Authors>Your Name</Authors>
  <Description>プロペラ形状データを扱う .NET ライブラリ</Description>
  <PackageTags>propeller;dataset;json</PackageTags>
</PropertyGroup>
```

- CI で公開する場合は `dotnet pack -c Release /p:ContinuousIntegrationBuild=true` → `dotnet nuget push`。GitHub Actions で secrets (`NUGET_API_KEY`) を設定し、手動トリガー（`workflow_dispatch`）で実行する。
- `IsPackable=false` になっていないプロジェクトが紛れ込んでいないか、`dotnet pack` 前にチェックする。

---

## 19. ドキュメント・バッジ整備

- README にバッジを追加。

```md
[![CI](https://github.com/your/repo/actions/workflows/ci.yml/badge.svg)](https://github.com/your/repo/actions/workflows/ci.yml)
[![NuGet](https://img.shields.io/nuget/v/PropellerDataset.svg)](https://www.nuget.org/packages/PropellerDataset)
```

- `docs/` ディレクトリを作る場合は、テンプレートには含めずに別リポジトリや GitHub Pages で管理する方針を決めておく。
- API ドキュメント自動生成（`docfx` や `xml` ドキュメントコメント）を行うなら、`Directory.Build.props` に `<GenerateDocumentationFile>true</GenerateDocumentationFile>` を追加し、CI で成果物化する。
- チーム規模が大きくなったら、`CONTRIBUTING.md` に PR テンプレ・レビューポリシーを明記し、`.github/` 以下で自動化する。

---

## 20. 今後のメンテナンスメモ

- テンプレート更新時は `dotnet new --uninstall <path>` → `dotnet new --install <path>` を忘れない。
- 変更をテンプレートに反映したら `structure.txt` など補助資料も更新して、生成物との差分を小さく保つ。
- PR レビュー時に活用できるよう、ここに Q&A を追加し続ける。